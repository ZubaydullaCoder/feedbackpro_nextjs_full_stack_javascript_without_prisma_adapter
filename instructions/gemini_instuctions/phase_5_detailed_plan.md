**Phase 5: SMS Feedback Channel**

- **Pre-Phase 5 Refactoring: Aligning QR Code Flow with Rewardable SMS Mechanism**
  - **1. Goal:** Modify the existing QR code feedback flow (from Phase 4) to route users through an SMS opt-in. This enables rewards for QR-initiated feedback by using the same unique, single-use SMS link mechanism planned for direct BO SMS invites.
  - **2. Rationale:** To make QR-code initiated feedback eligible for rewards (Phase 6), we need a way to issue a unique, trackable link. Direct anonymous submission via `/s/[surveyId]` is unsuitable for rewards. This change standardizes rewardable feedback through unique SMS links.
  - **3. Tasks (for AI Assist):**
    - **3.1. Repurpose Public Survey Entry Page (`app/(public)/s/[surveyId]/page.jsx`):**
      - **Data Fetching:** This page will still fetch basic survey information (e.g., `survey.name`, `survey.business.name`) to display context to the user. It no longer needs to fetch survey questions.
      - **UI Change:**
        - Remove the direct rendering of `SurveyDisplayForm`.
        - The page will now display the survey name and a prompt for the user to enter their phone number to receive the survey link via SMS.
        - Integrate a new client component: `components/features/feedback/phone-number-opt-in-form.jsx`.
    - **3.2. Create `PhoneNumberOptInForm.jsx`:**
      - Location: `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\components\features\feedback\phone-number-opt-in-form.jsx`
      - Client component (`"use client"`).
      - UI: An input field for the phone number (use Shadcn `Input`) and a submit button (Shadcn `Button`).
      - Form Handling: Use `react-hook-form` and `zod` for phone number validation (e.g., basic E.164 format).
      - On Submit: Call a new server action `requestSurveyLinkViaSms`, passing `surveyId` and `phoneNumber`.
      - Feedback: Handle loading states (disable button, show spinner). Display success toast (e.g., "SMS on its way!") or error toast using `useToast`. After successful submission, the form could be replaced by a confirmation message.
    - **3.3. Create Server Action `requestSurveyLinkViaSms`:**
      - Location: `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\lib\actions\sms.actions.js` (or a new `feedback_request.actions.js` if preferred for organization).
      - Parameters: `({ surveyId, phoneNumber })`.
      - Validation: Use Zod for `surveyId` (cuid) and `phoneNumber`.
      - Logic:
        - Verify `surveyId` corresponds to an existing, active survey (Prisma query).
        - Create a `ResponseEntity` record (Prisma):
          - `surveyId`: from input.
          - `type`: `'QR_INITIATED_SMS'` (to distinguish from BO-sent SMS).
          - `status`: `'PENDING'`.
          - `phoneNumber`: Store the validated `phoneNumber` (consider privacy implications if this data is sensitive and not strictly needed long-term beyond sending the initial SMS).
        - Generate unique feedback URL: `const uniqueUrl = \`\${process.env.NEXTAUTH_URL}/feedback/\${newResponseEntity.id}\`;`.
        - Call the (simulated) `sendSms` helper: `await sendSms(validatedPhoneNumber, \`Here is your link for the \${survey.name} survey: \${uniqueUrl}\`);`
        - Return success/error object for the client.
    - **3.4. Modify `submitFeedback` Server Action (`lib/actions/feedback.actions.js`):**
      - **Remove `type` from input schema:** The `type` field (previously 'QR' or 'SMS') in the `submitFeedbackSchema` is no longer needed. All submissions will now be identified by `responseEntityId`.
      - **Remove logic for creating new `ResponseEntity` of type 'QR':** The action should no longer create a `ResponseEntity` on its own. It will _always_ expect a `responseEntityId` to be passed in.
      - **Adapt input schema:** The `submitFeedbackSchema` should now require `responseEntityId: z.string().cuid()`.
      - **Core Logic:**
        - Fetch the `ResponseEntity` using the provided `responseEntityId`.
        - **Crucial Check:** Verify `responseEntity` exists and `responseEntity.status === 'PENDING'`. If not, return an error (e.g., "Feedback already submitted or link is invalid.").
        - Proceed to create `Response` records and link them to this `responseEntityId`.
        - Atomically (Prisma transaction) update the `ResponseEntity` status to `'COMPLETED'` and set `submittedAt`.
    - **3.5. Update `SurveyDisplayForm.jsx` (`components/features/feedback/survey-display-form.jsx`):**
      - **Props:** This component will now receive `responseEntityId` as a prop from its parent page (`app/(public)/feedback/[responseEntityId]/page.jsx`).
      - **Data Submission:** When calling `submitFeedback`, pass the `responseEntityId` along with `surveyId` and `answers`. Remove the hardcoded `type: "QR"`.
      - **Local Storage `feedbackSubmitted_${survey.id}`:** This client-side check can be removed or re-evaluated. The primary mechanism for preventing re-submission is now the server-side check of `ResponseEntity.status` based on the unique `responseEntityId` in the URL. The unique link itself serves as the gate.
  - **4. Check Instructions (Refactoring):**
    - Navigate to a QR code link (e.g., `/s/your-survey-id`).
    - Verify the page displays survey context (name) and a form to enter a phone number, not the full survey.
    - Enter a valid phone number and submit.
    - Verify a (simulated) SMS is logged in the server console, containing a unique URL like `/feedback/[generated-response-entity-id]`.
    - Verify a new `ResponseEntity` record is created in the database with `type: 'QR_INITIATED_SMS'`, `status: 'PENDING'`, and linked to the correct `surveyId`.
    - Access the unique URL from the console log.
    - Verify the full survey loads correctly (via `SurveyDisplayForm`).
    - Submit feedback through this unique link.
    - Verify the `ResponseEntity` status is updated to `COMPLETED` in the database.
    - Verify the `Response` records are created and correctly associated.
    - Attempt to access the same unique URL again. Verify the "Feedback already submitted" message (or equivalent) is shown, and the form is not rendered (this logic is in `app/(public)/feedback/[responseEntityId]/page.jsx`).

---

**Phase 5: SMS Feedback Channel**

- **1. Overall Goal:** Implement the (simulated) SMS sending capability for Business Owners to invite recipients to surveys, and enable feedback submission via these unique links. This phase also builds upon the refactored QR flow, where QR scans now also lead to an SMS-delivered unique link.

- **2. Prerequisite: Simulated SMS Sending Setup (as per previous plan, if not already done)**

  - **2.1. Task:** Create/ensure a helper module to simulate SMS sending. This module will log the intended SMS details.
  - **2.2. Detailed Steps & Considerations:**
    - **Simulated SMS Helper Module:**
      - File: `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\lib\sms\sendSms.js`
      - Content: `async function sendSms(to, body)` that logs `[SMS SIMULATION] To: ${to}, Body: ${body}` and returns `{ success: true }`.
  - **2.3. Check Instructions (Prerequisite):**
    - Confirm `lib/sms/sendSms.js` exists, exports `sendSms`, and logs correctly when called.

- **3. Business Owner UI for Sending Direct SMS Invites**

  - **3.1. Task:** Add UI elements to the Business Owner's survey details page to input a phone number and trigger sending a (simulated) SMS with the unique survey link.
  - **3.2. Detailed Steps & Considerations:**
    - **File to Modify:** `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\components\features\surveys\survey-details-client.jsx`. Consider a new sub-component (e.g., `SmsInviteForm.jsx`) if UI/logic is substantial.
    - **UI Elements (Shadcn UI & Tailwind CSS):**
      - Input field for phone number (Shadcn `Input`).
      - Button "Send SMS Invite" (Shadcn `Button`).
      - Form handling: `react-hook-form` for validation and state.
    - **Functionality:**
      - On submit, call `sendDirectFeedbackSms` server action (see step 4), passing `surveyId` and `phoneNumber`.
      - Display success/error toasts using `useToast`.
    - **Best Practices:** UI/UX (clear labels, feedback), Modularity.
    - **Reusable Assets:** Shadcn components, `useToast`, `react-hook-form`.
  - **3.3. Check Instructions (BO UI for SMS):**
    - Verify UI elements render on survey details page for BO.
    - Confirm client-side phone number validation.
    - Verify button click calls `sendDirectFeedbackSms` action.

- **4. Server Action for BO to Send Direct Feedback SMS (`sendDirectFeedbackSms`)**

  - **4.1. Task:** Create a server action for Business Owners to send (simulated) SMS invitations.
  - **4.2. Detailed Steps & Considerations:**
    - **File to Modify/Create:** `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\lib\actions\sms.actions.js` (add new action or ensure distinct from `requestSurveyLinkViaSms`).
    - **Function: `async function sendDirectFeedbackSms({ surveyId, phoneNumber })`**
      - **Authentication & Authorization:**
        - Use `auth()` from `lib/auth.js`. Verify `session.user` is an active `BUSINESS_OWNER`.
        - Verify the `surveyId` belongs to the authenticated BO.
      - **Input Validation (Zod):** Schema for `surveyId`, `phoneNumber`.
      - **Create `ResponseEntity` (Prisma):**
        - `surveyId`: from input.
        - `type`: `'DIRECT_SMS'` (to distinguish from QR-initiated).
        - `status`: `'PENDING'`.
        - `phoneNumber`: (Optional storage, consider privacy).
      - **Generate Unique Feedback URL:** `const uniqueUrl = \`\${process.env.NEXTAUTH_URL}/feedback/\${newResponseEntity.id}\`;`
      - **Call Simulated SMS Helper:** `await sendSms(validatedPhoneNumber, \`Message from BO for survey \${survey.name}: \${uniqueUrl}\`);`
      - **Return Value:** `{ success: true, message: 'SMS (simulated) sent.' }` or error.
    - **Best Practices:** Next.js Server Actions, Clean Code, Error Handling.
  - **4.3. Check Instructions (Server Action `sendDirectFeedbackSms`):**
    - When triggered from BO UI:
      - A new `ResponseEntity` (type `DIRECT_SMS`, status `PENDING`) is created.
      - Server console logs simulated SMS with correct details.
      - BO UI shows success toast.

- **5. Unique Public Feedback Page (`/feedback/[responseEntityId]`)**

  - **5.1. Task:** Ensure this dynamic public page correctly displays the survey for a given `responseEntityId` and handles already completed submissions. (This page structure should largely exist from Phase 4's original plan for unique links, but now it's the central point for all SMS-delivered links).
  - **5.2. Detailed Steps & Considerations:**
    - **File:** `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\app\(public)\feedback\[responseEntityId]\page.jsx`
    - **Data Fetching (Server Component):**
      - `async function Page({ params })`. Extract `responseEntityId`.
      - Fetch `ResponseEntity` via Prisma, `include: { survey: { include: { questions: ... } } }`.
      - **Status Check & Error Handling:**
        - If `!responseEntity` or `!responseEntity.survey`, show "Link invalid or survey not found."
        - If `responseEntity.status === 'COMPLETED'`, show "Feedback already submitted for this link." and do NOT render the form.
    - **UI Rendering:**
      - If valid and `PENDING`, pass `responseEntity.survey` and `responseEntity.id` (as `responseEntityId`) to `SurveyDisplayForm`.
    - **Best Practices:** Next.js Rendering, UX for link states.
    - **Reusable Assets:** `SurveyDisplayForm`.
  - **5.3. Check Instructions (Unique Feedback Page):**
    - Generate an invite (either via BO UI or QR opt-in).
    - Access the unique URL from the (simulated) SMS.
    - If `ResponseEntity` is `PENDING`, verify survey loads via `SurveyDisplayForm`.
    - After submitting feedback (step 6), re-access URL. Verify "Feedback already submitted" message.
    - Test with an invalid `responseEntityId`. Verify "Link invalid" message.

- **6. Updated Feedback Submission Logic (Handled by Pre-Phase 5 Refactoring)**

  - **6.1. Task:** Ensure the `submitFeedback` server action correctly handles submissions originating from these unique links, using the `responseEntityId`.
  - **6.2. Summary of Changes (from Pre-Phase 5 Refactoring):**
    - `lib/actions/feedback.actions.js` (`submitFeedback`):
      - Now _requires_ `responseEntityId`.
      - Fetches `ResponseEntity` by `responseEntityId`.
      - Verifies `status === 'PENDING'`.
      - Creates `Response` records linked to this `responseEntityId`.
      - Atomically updates `ResponseEntity` status to `COMPLETED`.
      - No longer creates 'QR' type `ResponseEntity` records itself.
    - `components/features/feedback/survey-display-form.jsx`:
      - Receives `responseEntityId` as a prop.
      - Passes `responseEntityId` to `submitFeedback`.
  - **6.3. Check Instructions (Feedback Submission via Unique Link):**
    - Submit feedback via a unique link (from either BO invite or QR opt-in).
    - Verify consumer UI success toast.
    - DB: `ResponseEntity` status `COMPLETED`, `submittedAt` populated. `Response` records linked.
    - Attempt re-submission via the same link. Verify it's blocked by the `/feedback/[responseEntityId]/page.jsx` logic and/or the `submitFeedback` action's pre-submission check.

- **7. BO Viewing & Tracking of All SMS-Initiated Responses**

  - **7.1. Task:** Update the BO's survey details page to display all responses submitted via unique links (both `DIRECT_SMS` and `QR_INITIATED_SMS`) and provide a tracking list for all SMS invitations/requests.
  - **7.2. Detailed Steps & Considerations:**
    - **Files to Modify:**
      - `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\app\(bo)\surveys\[surveyId]\page.jsx` (Server Component for data fetching)
      - `d:\web development\2025\codevision works\feedbackpro-web-app\full_stack_nextjs\attempt_5_javascript\components\features\surveys\survey-details-client.jsx` (Client Component for UI rendering)
    - **Data Fetching (in `page.jsx`):**
      - Modify Prisma query to fetch all `ResponseEntity` records for the `surveyId`, including types `DIRECT_SMS` and `QR_INITIATED_SMS`.
      - Include related `responses` for display.
      - Example: `include: { responseEntities: { include: { responses: { include: { question: true } } }, orderBy: { createdAt: 'desc' } } }`
    - **UI Updates (in `survey-details-client.jsx`):**
      - **Consolidated Response Display:**
        - The existing `ResponseViewer` component should already be capable of displaying responses based on `ResponseEntity` data. Ensure it clearly shows the `responseEntity.type` (e.g., "SMS Invite", "QR Scan SMS") using the Badge component.
      - **SMS Invitation/Request Tracking List:**
        - Add a new section/tab, e.g., "SMS Log" or "Link Invitations".
        - Use Shadcn `Table` to display all `ResponseEntity` records where `type` is `DIRECT_SMS` or `QR_INITIATED_SMS`.
        - Columns: "Type" (`DIRECT_SMS`/`QR_INITIATED_SMS`), "Sent To" (phone number, if stored and displayable), "Sent At" (`ResponseEntity.createdAt`), "Status" (`ResponseEntity.status`), "Submitted At".
    - **Best Practices:** Efficient data flow, Clear UI for BO.
  - **7.3. Check Instructions (BO Viewing & Tracking):**
    - Log in as BO, navigate to survey details.
    - Verify responses submitted via both direct SMS invites and QR-initiated SMS links are displayed in the `ResponseViewer`, with their origin type clear.
    - Verify the "SMS Log" table accurately lists all `DIRECT_SMS` and `QR_INITIATED_SMS` `ResponseEntity` records with correct status and timestamps.
    - Confirm status updates in the log as feedback is submitted.

- **3. Check Instructions (Detailed):**
  - **QR Flow Test:**
    - Access `/s/[surveyId]`. Enter phone. Verify (simulated) SMS log & DB `ResponseEntity` (type `QR_INITIATED_SMS`, status `PENDING`).
    - Open unique link. Submit feedback. Verify DB updates.
  - **BO Direct SMS Flow Test:**
    - Log in as BO, go to survey details, use "Send SMS Invite" UI. Enter phone. Verify BO toast, (simulated) SMS log & DB `ResponseEntity` (type `DIRECT_SMS`, status `PENDING`).
    - Open unique link from this invite. Submit feedback. Verify DB updates.
  - **Common Checks for Both Flows:**
    - Verify consumer success toast on feedback submission.
    - Verify `ResponseEntity` status updates to `COMPLETED` and `submittedAt` is populated.
    - Verify `Response` records are correctly created and associated.
    - Attempt to re-use a unique link after submission. Verify "Feedback already submitted" message and no form.
  - **BO Dashboard Verification:**
    - Log in as BO, view survey details.
    - Verify responses from both flows are displayed in `ResponseViewer`, with type indicated.
    - Verify the "SMS Log" table shows entries for both `QR_INITIATED_SMS` and `DIRECT_SMS`, with correct status ("PENDING" then "COMPLETED").
